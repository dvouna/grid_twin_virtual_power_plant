name: Deploy to Cloud Run

on:
  push:
    branches: [ "main", "develop" ]

env:
  REGION: us-central1

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Deploy to Cloud Run
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          # Dynamic service name based on branch: main -> vpp-mcp-server, develop -> vpp-mcp-server-stage
          service: ${{ github.ref == 'refs/heads/main' && 'vpp-mcp-server' || 'vpp-mcp-server-stage' }}
          region: ${{ env.REGION }}
          # Source-based deploy handles container build automatically uses Buildpacks
          source: .
          # Preserve InfluxDB and Transport config
          env_vars: |-
            INFLUX_CLOUD_URL=${{ secrets.INFLUX_CLOUD_URL }}
            INFLUX_CLOUD_TOKEN=${{ secrets.INFLUX_CLOUD_TOKEN }}
            INFLUX_CLOUD_ORG=${{ secrets.INFLUX_CLOUD_ORG }}
            INFLUX_CLOUD_BUCKET=${{ secrets.INFLUX_CLOUD_BUCKET }}
            MCP_TRANSPORT=sse
