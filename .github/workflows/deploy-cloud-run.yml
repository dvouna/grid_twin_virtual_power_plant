name: Deploy to Cloud Run

on:
  push:
    branches: [ "main", "develop" ]

env:
  REGION: us-central1
  GCP_PROJECT_ID: igneous-study-486512-g4
  WIF_PROVIDER_NAME: projects/207186852167/locations/global/workloadIdentityPools/vpp-provider/providers/github-provider
  GCP_SERVICE_ACCOUNT: vpp-mcp-sa@igneous-study-486512-g4.iam.gserviceaccount.com

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff pytest # Ensure test tools are installed

      - name: Run Ruff Linter
        run: ruff check src/ tests/ --output-format=github

      - name: Run Pytest
        env:
          PYTHONPATH: src
        run: pytest -m "not integration" -v

  deploy-staging:
    name: Deploy to Staging
    needs: test
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    environment: staging
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ env.WIF_PROVIDER_NAME }}'
          service_account: '${{ env.GCP_SERVICE_ACCOUNT }}'

      - name: Deploy to Cloud Run (Staging)
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: vpp-mcp-server-stage
          region: ${{ env.REGION }}
          source: .
          # Use dedicated inputs instead of a single 'flags' string to avoid parsing errors
          metadata: '' 
          timeout: '300s'
          cpu_boost: true
          # Cloud Run Action specific inputs for Probes
          startup_probe_type: 'http'
          startup_probe_path: '/sse'
          liveness_probe_type: 'http'
          liveness_probe_path: '/sse'
          # Use 'flags' only for items without dedicated inputs
          flags: '--memory=1Gi' 
          secrets: |-
            INFLUX_CLOUD_URL=INFLUX_CLOUD_URL:latest
            INFLUX_CLOUD_TOKEN=INFLUX_CLOUD_TOKEN:latest
            INFLUX_CLOUD_ORG=INFLUX_CLOUD_ORG:latest
            INFLUX_CLOUD_BUCKET=INFLUX_CLOUD_BUCKET:latest
          env_vars: |-
            MCP_TRANSPORT=sse

  deploy-production:
    name: Deploy to Production
    needs: [test, deploy-staging]
    if: github.ref == 'refs/heads/main'
    environment: production
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ env.WIF_PROVIDER_NAME }}'
          service_account: '${{ env.GCP_SERVICE_ACCOUNT }}'

      - name: Deploy to Cloud Run (Production)
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: vpp-mcp-server
          region: ${{ env.REGION }}
          source: .
          cpu_boost: true
          startup_probe_type: 'http'
          startup_probe_path: '/sse'
          liveness_probe_type: 'http'
          liveness_probe_path: '/sse'
          flags: '--memory=1Gi'
          secrets: |-
            INFLUX_CLOUD_URL=INFLUX_CLOUD_URL:latest
            INFLUX_CLOUD_TOKEN=INFLUX_CLOUD_TOKEN:latest
            INFLUX_CLOUD_ORG=INFLUX_CLOUD_ORG:latest
            INFLUX_CLOUD_BUCKET=INFLUX_CLOUD_BUCKET:latest
          env_vars: |-
            MCP_TRANSPORT=sse